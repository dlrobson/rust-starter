name: Prepare CI Image

on:
  workflow_call:
    inputs:
      registry:
        description: "The Docker registry to push to"
        required: true
        type: string
      image-name:
        description: "The name of the Docker image"
        required: true
        type: string
      dockerfile-context:
        description: "The context path for the Dockerfile"
        required: true
        type: string
    outputs:
      image:
        description: "The full image reference (registry/name:tag)"
        value: ${{ jobs.get-tag.outputs.image }}
    secrets:
      token:
        description: "GitHub token for authentication"
        required: true

jobs:
  get-tag:
    runs-on: ubuntu-slim
    outputs:
      tag: ${{ steps.determine-tag.outputs.tag }}
      should-build: ${{ steps.determine-tag.outputs.should-build }}
      should-retag: ${{ steps.determine-tag.outputs.should-retag }}
      image: ${{ steps.determine-tag.outputs.image }}
    steps:
      - uses: actions/checkout@v6

      - name: Compute content hash
        id: content-hash
        env:
          FULL_HASH: ${{ hashFiles(format('{0}/**', inputs.dockerfile-context)) }}
        run: |
          # Truncate to 12 characters for shorter tags
          CONTENT_HASH="${FULL_HASH:0:12}"
          
          echo "hash=$CONTENT_HASH" >> "$GITHUB_OUTPUT"
          echo "Computed content hash: $CONTENT_HASH (from $FULL_HASH)"

      - name: Check if on main branch
        id: check-main
        run: |
          if [ "$GITHUB_REF" = "refs/heads/main" ]; then
            echo "is-main-push=true" >> "$GITHUB_OUTPUT"
          else
            echo "is-main-push=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.token }}

      - name: Check if image exists
        id: check-image
        run: |
          IMAGE="${{ inputs.registry }}/${{ inputs.image-name }}:${{ steps.content-hash.outputs.hash }}"
          
          if docker manifest inspect "$IMAGE" > /dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Image already exists: $IMAGE"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Image does not exist: $IMAGE"
          fi

      - name: Determine image tag
        id: determine-tag
        run: |
          CONTENT_HASH="${{ steps.content-hash.outputs.hash }}"
          IMAGE_EXISTS="${{ steps.check-image.outputs.exists }}"
          IS_MAIN_PUSH="${{ steps.check-main.outputs.is-main-push }}"
          
          SHOULD_BUILD="false"
          SHOULD_RETAG="false"

          if [ "$IMAGE_EXISTS" == "true" ]; then
            echo "Image with content hash $CONTENT_HASH already exists - reusing"
            # If on main, still retag to latest even if image exists
            if [ "$IS_MAIN_PUSH" == "true" ]; then
              SHOULD_RETAG="true"
              echo "Main branch push - will retag to latest"
            fi
          else
            echo "Image with content hash $CONTENT_HASH does not exist - building"
            SHOULD_BUILD="true"
            # If on main, also retag to latest after building
            if [ "$IS_MAIN_PUSH" == "true" ]; then
              SHOULD_RETAG="true"
              echo "Main branch push - will also retag to latest"
            fi
          fi
          
          echo "tag=$CONTENT_HASH" >> "$GITHUB_OUTPUT"
          echo "image=${{ inputs.registry }}/${{ inputs.image-name }}:$CONTENT_HASH" >> "$GITHUB_OUTPUT"
          echo "should-build=$SHOULD_BUILD" >> "$GITHUB_OUTPUT"
          echo "should-retag=$SHOULD_RETAG" >> "$GITHUB_OUTPUT"

  retag-to-latest:
    needs: get-tag
    if: needs.get-tag.outputs.should-retag == 'true'
    uses: ./.github/workflows/retag-image.yml
    with:
      registry: ${{ inputs.registry }}
      image-name: ${{ inputs.image-name }}
      source-tag: ${{ needs.get-tag.outputs.tag }}
      target-tag: latest
    secrets:
      token: ${{ secrets.token }}

  build-image:
    needs: get-tag
    if: needs.get-tag.outputs.should-build == 'true'
    uses: ./.github/workflows/build-image.yml
    with:
      registry: ${{ inputs.registry }}
      image-name: ${{ inputs.image-name }}
      image-tag: ${{ needs.get-tag.outputs.tag }}
      dockerfile-context: ${{ inputs.dockerfile-context }}
    secrets:
      token: ${{ secrets.token }}
